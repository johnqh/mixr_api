# MIXR API - Required Backend Changes

## Authentication Requirements

### Firebase Token Verification

All user-specific endpoints MUST verify the Firebase ID token passed in the `Authorization` header:

```
Authorization: Bearer <firebase_id_token>
```

**Implementation Requirements:**
1. Extract token from `Authorization: Bearer {token}` header
2. Verify token using Firebase Admin SDK
3. Extract user information (uid, email) from verified token
4. Use Firebase UID as the primary user identifier
5. Return 401 Unauthorized if token is missing or invalid
6. Return 403 Forbidden if user doesn't have permission for the resource

**Token Payload Structure:**
```json
{
  "uid": "firebase_user_id",
  "email": "user@example.com",
  "email_verified": true,
  "auth_time": 1234567890,
  "iss": "https://securetoken.google.com/project-id",
  "aud": "project-id",
  "exp": 1234567890,
  "iat": 1234567890
}
```

---

## New Endpoints Required

### 1. User Management

#### GET /api/users/me
**Purpose**: Get current user's profile information

**Authentication**: Required (Firebase token)

**Response**:
```json
{
  "success": true,
  "data": {
    "id": "firebase_uid",
    "email": "user@example.com",
    "display_name": "John Doe",
    "created_at": "2025-01-18T00:00:00Z",
    "updated_at": "2025-01-18T00:00:00Z"
  }
}
```

#### PUT /api/users/me
**Purpose**: Update current user's profile

**Authentication**: Required (Firebase token)

**Request Body**:
```json
{
  "display_name": "John Doe"
}
```

**Response**: Same as GET /api/users/me

---

### 2. User Preferences (Equipment & Ingredients)

#### GET /api/users/me/preferences
**Purpose**: Get user's saved equipment and ingredient preferences

**Authentication**: Required (Firebase token)

**Response**:
```json
{
  "success": true,
  "data": {
    "equipment_ids": [1, 2, 3, 5, 8],
    "ingredient_ids": [10, 15, 20, 25, 30],
    "updated_at": "2025-01-18T00:00:00Z"
  }
}
```

#### PUT /api/users/me/preferences
**Purpose**: Update user's equipment and ingredient preferences

**Authentication**: Required (Firebase token)

**Request Body**:
```json
{
  "equipment_ids": [1, 2, 3],
  "ingredient_ids": [10, 15, 20]
}
```

**Response**: Same as GET /api/users/me/preferences

---

### 3. Recipe Ratings & Reviews

#### POST /api/recipes/{recipe_id}/ratings
**Purpose**: Submit or update a rating/review for a recipe

**Authentication**: Required (Firebase token)

**Request Body**:
```json
{
  "stars": 5,
  "review": "Amazing cocktail! The perfect balance of flavors."
}
```

**Notes**:
- `stars`: Required, integer 1-5
- `review`: Optional, string max 500 characters
- If user already rated this recipe, update existing rating
- Otherwise, create new rating

**Response**:
```json
{
  "success": true,
  "data": {
    "id": 123,
    "recipe_id": 456,
    "user_id": "firebase_uid",
    "user_name": "John Doe",
    "user_email": "john@example.com",
    "stars": 5,
    "review": "Amazing cocktail! The perfect balance of flavors.",
    "created_at": "2025-01-18T00:00:00Z",
    "updated_at": "2025-01-18T00:00:00Z"
  }
}
```

#### GET /api/recipes/{recipe_id}/ratings
**Purpose**: Get all ratings/reviews for a recipe

**Authentication**: Optional (public endpoint)

**Query Parameters**:
- `limit`: Number of ratings to return (default: 20, max: 100)
- `offset`: Pagination offset (default: 0)
- `sort`: Sort order - `newest`, `oldest`, `highest`, `lowest` (default: newest)

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "recipe_id": 456,
      "user_id": "firebase_uid",
      "user_name": "John Doe",
      "user_email": "john@example.com",
      "stars": 5,
      "review": "Amazing cocktail!",
      "created_at": "2025-01-18T00:00:00Z",
      "updated_at": "2025-01-18T00:00:00Z"
    }
  ],
  "count": 127
}
```

#### GET /api/recipes/{recipe_id}/ratings/aggregate
**Purpose**: Get aggregate rating statistics for a recipe

**Authentication**: Optional (public endpoint)

**Response**:
```json
{
  "success": true,
  "data": {
    "recipe_id": 456,
    "average_rating": 4.5,
    "total_ratings": 127,
    "rating_distribution": {
      "1": 2,
      "2": 3,
      "3": 12,
      "4": 32,
      "5": 78
    }
  }
}
```

#### DELETE /api/recipes/{recipe_id}/ratings/{rating_id}
**Purpose**: Delete user's own rating

**Authentication**: Required (Firebase token)

**Authorization**: User can only delete their own ratings

**Response**:
```json
{
  "success": true,
  "message": "Rating deleted successfully"
}
```

---

### 4. User Recipe Collections

#### GET /api/users/me/recipes
**Purpose**: Get recipes generated by the current user

**Authentication**: Required (Firebase token)

**Query Parameters**:
- `limit`: Number of recipes to return (default: 20)
- `offset`: Pagination offset (default: 0)

**Response**: Same format as GET /api/recipes

**Notes**:
- When a recipe is generated via POST /api/recipes/generate, automatically associate it with the authenticated user

#### GET /api/users/me/favorites
**Purpose**: Get user's favorite recipes

**Authentication**: Required (Firebase token)

**Query Parameters**:
- `limit`: Number of recipes to return (default: 20)
- `offset`: Pagination offset (default: 0)

**Response**: Same format as GET /api/recipes

#### POST /api/users/me/favorites
**Purpose**: Add a recipe to user's favorites

**Authentication**: Required (Firebase token)

**Request Body**:
```json
{
  "recipe_id": 456
}
```

**Response**:
```json
{
  "success": true,
  "message": "Recipe added to favorites"
}
```

#### DELETE /api/users/me/favorites/{recipe_id}
**Purpose**: Remove a recipe from user's favorites

**Authentication**: Required (Firebase token)

**Response**:
```json
{
  "success": true,
  "message": "Recipe removed from favorites"
}
```

---

## Updated Endpoints

### POST /api/recipes/generate
**Changes Required**:
1. Add Firebase token verification
2. Associate generated recipe with authenticated user (user_id = Firebase UID)
3. Store user's equipment_ids and ingredient_ids preferences when generating

**Current Request Body**:
```json
{
  "mood_id": 1,
  "equipment_ids": [1, 2, 3],
  "ingredient_ids": [10, 15, 20]
}
```

**Implementation Notes**:
- Extract user_id from verified Firebase token
- Store recipe with user_id for "My Recipes" feature
- If equipment_ids and ingredient_ids are empty, use user's saved preferences from /api/users/me/preferences

---

## Database Schema Changes

### New Tables Required

#### users
```sql
CREATE TABLE users (
  id VARCHAR(128) PRIMARY KEY,  -- Firebase UID
  email VARCHAR(255) NOT NULL UNIQUE,
  display_name VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_email (email)
);
```

#### user_preferences
```sql
CREATE TABLE user_preferences (
  user_id VARCHAR(128) PRIMARY KEY,
  equipment_ids JSON,  -- Array of equipment IDs
  ingredient_ids JSON, -- Array of ingredient IDs
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### recipe_ratings
```sql
CREATE TABLE recipe_ratings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  recipe_id BIGINT NOT NULL,
  user_id VARCHAR(128) NOT NULL,
  stars INT NOT NULL CHECK (stars >= 1 AND stars <= 5),
  review TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_user_recipe (user_id, recipe_id),
  INDEX idx_recipe_id (recipe_id),
  INDEX idx_user_id (user_id)
);
```

#### user_favorites
```sql
CREATE TABLE user_favorites (
  user_id VARCHAR(128) NOT NULL,
  recipe_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, recipe_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_recipe_id (recipe_id)
);
```

### Updated Tables

#### recipes
Add column:
```sql
ALTER TABLE recipes ADD COLUMN user_id VARCHAR(128);
ALTER TABLE recipes ADD FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL;
ALTER TABLE recipes ADD INDEX idx_user_id (user_id);
```

---

## Security Considerations

### Firebase Admin SDK Setup

Install Firebase Admin SDK:
```bash
npm install firebase-admin
```

Initialize in your backend:
```javascript
const admin = require('firebase-admin');

admin.initializeApp({
  credential: admin.credential.cert({
    projectId: process.env.FIREBASE_PROJECT_ID,
    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
    privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
  }),
});
```

### Token Verification Middleware

```javascript
async function verifyFirebaseToken(req, res, next) {
  const authHeader = req.headers.authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({
      success: false,
      error: 'Missing or invalid authorization header'
    });
  }

  const token = authHeader.split('Bearer ')[1];

  try {
    const decodedToken = await admin.auth().verifyIdToken(token);
    req.user = {
      uid: decodedToken.uid,
      email: decodedToken.email,
      emailVerified: decodedToken.email_verified
    };
    next();
  } catch (error) {
    return res.status(401).json({
      success: false,
      error: 'Invalid or expired token'
    });
  }
}
```

### Usage in Routes

```javascript
// Protected route example
app.get('/api/users/me', verifyFirebaseToken, async (req, res) => {
  const userId = req.user.uid; // Firebase UID from verified token
  // ... fetch user data
});

// Optional auth route (public but can be enhanced if authenticated)
app.get('/api/recipes/:id', optionalAuth, async (req, res) => {
  const userId = req.user?.uid; // May be undefined
  // ... fetch recipe, optionally include user-specific data
});
```

---

## Environment Variables Required

Add to `.env`:
```
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
```

---

## Implementation Priority

### Phase 1: High Priority (Required for MVP)
1. Firebase token verification middleware
2. User creation/management (POST auto-create on first authenticated request)
3. Recipe-user association (update POST /api/recipes/generate)
4. User preferences (GET/PUT /api/users/me/preferences)

### Phase 2: Medium Priority (Core Features)
1. Rating submission (POST /api/recipes/{id}/ratings)
2. Rating retrieval (GET /api/recipes/{id}/ratings)
3. Aggregate ratings (GET /api/recipes/{id}/ratings/aggregate)
4. User's recipes (GET /api/users/me/recipes)

### Phase 3: Nice to Have (Enhanced Features)
1. Favorites system (POST/DELETE /api/users/me/favorites, GET /api/users/me/favorites)
2. Rating deletion (DELETE /api/recipes/{id}/ratings/{rating_id})
3. User profile updates (PUT /api/users/me)

---

## Testing Requirements

### Authentication Testing
- Test with valid Firebase token
- Test with expired token
- Test with invalid token
- Test with missing token
- Test token from different Firebase project

### Authorization Testing
- User can only access/modify their own data
- User cannot delete other users' ratings
- User cannot modify other users' preferences

### Data Validation
- Rating stars must be 1-5
- Review text max 500 characters
- Equipment/ingredient IDs must exist
- Recipe IDs must exist

---

## Notes

1. **User Creation**: Consider auto-creating user records on first authenticated request rather than requiring explicit signup
2. **Display Names**: Extract from Firebase token or allow user to set via PUT /api/users/me
3. **Email Verification**: Consider requiring verified email for certain actions
4. **Rate Limiting**: Implement rate limiting on rating submissions to prevent abuse
5. **Caching**: Cache aggregate ratings for performance
6. **Soft Deletes**: Consider soft deletes for recipes and ratings for audit trail

---

## Frontend Integration

The frontend (`mixr` app) is already built and ready. Once these endpoints are implemented:

1. Remove mock data from `RecipeDetailPage.tsx`
2. Create hooks in `src/hooks/useRatings.ts`
3. Create hooks in `src/hooks/useUserRecipes.ts`
4. Update "My Recipes" tab in HomePage
5. Enable rating submission in RecipeDetailPage
6. Add favorites functionality to RecipeCard

All UI components are complete and waiting for backend integration.
